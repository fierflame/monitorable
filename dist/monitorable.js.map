{"version":3,"file":"monitorable.js","sources":["../src/utils.ts","../src/state.ts","../src/value.ts"],"sourcesContent":["/** 回调函数安全化处理 */\nexport function safeify<T extends any[]>(fn: (...p: T) => void): (...p: T) => void {\n\treturn (...p) => {\n\t\ttry {\n\t\t\tfn(...p);\n\t\t} catch(e) {\n\t\t\tconsole.error(e);\n\t\t}\n\t};\n}\n","import { safeify } from './utils';\n\nconst ValueMap = new WeakMap<object | Function, object | Function>();\nconst ProxyHandler: ProxyHandler<any> = {\n\tget(target, prop, receiver) {\n\t\tmarkRead(target, typeof prop === 'number' ? String(prop) : prop);\n\t\treturn Reflect.get(target, prop, receiver);\n\t\t// return getProxy(Reflect.get(target, prop, receiver));\n\t},\n\tset(target, prop, value, receiver) {\n\t\tif (Reflect.get(target, prop, receiver) !== value) {\n\t\t\tmarkChange(target, typeof prop === 'number' ? String(prop) : prop);\n\t\t}\n\t\treturn Reflect.set(target, prop, value, receiver);\n\t},\n\t// getOwnPropertyDescriptor(target, prop) {\n\t// \tmarkRead(target, typeof prop === 'number' ? String(prop) : prop);\n\t// \tconst descriptor = Reflect.getOwnPropertyDescriptor(target, prop);\n\t// \tif (descriptor && 'value' in descriptor) {\n\t// \t\tdescriptor.value = getProxy(descriptor.value);\n\t// \t}\n\t// \treturn descriptor;\n\t// },\n\t// defineProperty(target, prop, attributes) {\n\t// \t// TODO\n\t// \treturn Reflect.defineProperty(target, prop, attributes);\n\t// },\n\t// deleteProperty(target, prop) {\n\t// \t// TODO\n\t// \treturn Reflect.deleteProperty(target, prop);\n\t// },\n\t// enumerate(target) {\n\t// \t// TODO\n\t// \treturn [...Reflect.enumerate(target)];\n\t// },\n};\n\nfunction isProxyable(v: any): v is object | Function {\n\treturn Boolean(v && ['object', 'function'].includes(typeof v));\n}\n\nexport function getProxy<T>(v: T): T {\n\tif (!isProxyable(v)) { return v; }\n\tif (ValueMap.has(v)) { return v; }\n\treturn new Proxy(v, ProxyHandler);\n}\nexport function getValue<T>(v: T): T {\n\treturn ValueMap.get(v as any) as T | undefined || v;\n}\nexport function equal(a: any, b: any): boolean {\n\treturn getValue(a) === getValue(b);\n}\n\n/** 已被读取的 */\nlet read: Map<object | Function, Set<string | symbol>> | undefined;\nexport function markRead(obj: object | Function, prop: string | symbol) {\n\tif (!read) { return; }\n\tlet set = read.get(obj);\n\tif (!set) {\n\t\tset = new Set();\n\t\tread.set(obj, set);\n\t}\n\tset.add(prop);\n}\nexport interface Executable<T> {\n\t(): T;\n\tstop(): void;\n}\nexport function createExecutable<T>(fn: () => T, cb: (changed: boolean) => void): Executable<T> {\n\tcb = safeify(cb);\n\tlet cancelList: (() => void)[] | undefined;\n\t/** 取消监听 */\n\tfunction cancel() {\n\t\tif (!cancelList) { return false; }\n\t\tconst list = cancelList;\n\t\tcancelList = undefined;\n\t\tlist.forEach(f => f());\n\t\treturn true;\n\t}\n\tfunction trigger() {\n\t\tif (!cancel()) { return; }\n\t\tcb(true);\n\t};\n\tfunction exec() {\n\t\tcancel();\n\t\tconst thisRead: typeof read = new Map();\n\t\tconst oldRead = read;\n\t\tread = thisRead;\n\t\ttry {\n\t\t\treturn fn();\n\t\t} catch (e) {\n\t\t\tthisRead.clear();\n\t\t\tthrow e;\n\t\t} finally {\n\t\t\tread = oldRead;\n\t\t\tif (thisRead.size) {\n\t\t\t\tcancelList = [];\n\t\t\t\tfor ( let [obj, props] of thisRead) {\n\t\t\t\t\tfor (const p of props) {\n\t\t\t\t\t\tcancelList.push(watchProp(obj, p, trigger));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tcb(false);\n\t\t\t}\n\t\t}\n\t}\n\texec.stop = () => {\n\t\tif (!cancel()) { return; }\n\t\tcb(false);\n\t};\n\treturn exec;\n}\n\n\nexport const watchList = new WeakMap<object | Function, Map<string | symbol, (() => void)[]>>();\n\n/**\n * 监听对象属性的变化\n * @param v 要监听属性的值\n * @param key 要监听的属性名\n * @param f 属性改变后触发的函数\n */\nexport function watchProp(v: object | Function, key: string | symbol, f: () => void): () => void {\n\tif (!v) { return () => {}; }\n\tif (!(typeof v === 'object' || typeof v === 'function')) { return () => {}; }\n\tif (typeof f !== 'function') { return  () => {}; }\n\tif (typeof key !== 'symbol' && typeof key !== 'string') { return () => {}; }\n\tv = getValue(v);\n\tlet map = watchList.get(v);\n\tif (!map) {\n\t\tmap = new Map();\n\t\twatchList.set(v, map);\n\t}\n\tlet list = map.get(key);\n\tif (!list) {\n\t\tlist = [];\n\t\tmap.set(key, list);\n\t}\n\tlist.push(f);\n\tlet removed = false;\n\treturn () => {\n\t\tif (removed) { return; }\n\t\tremoved = true;\n\n\t\t// 从当前列表中移除\n\t\tif (!list) { return; }\n\t\tconst index = list.findIndex(a => a === f);\n\t\tif (index < 0) { return; }\n\t\tlist.splice(index, 1);\n\n\t\t// 从属性关联中删除\n\t\tif (list.length) { return; }\n\t\tif (!map) { return; }\n\t\tmap.delete(key);\n\n\t\t// 映射列表中删除\n\t\tif (map.size) { return; }\n\t\twatchList.delete(v);\n\t};\n\n}\n\n/** \n * 标记属性的修改，同时触发监听函数\n */\nexport function markChange(v: object | Function, key: string | symbol) {\n\tif (!v) { return; }\n\tif (!(typeof v === 'object' || typeof v === 'function')) { return; }\n\tif (typeof key === 'number') {\n\t\tkey = String(key);\n\t} else if (typeof key !== 'symbol' && typeof key !== 'string') {\n\t\treturn;\n\t}\n\n\tconst watch = watchList.get(v)?.get?.(key);\n\tif (!watch) { return; }\n\tfor (const w of [...watch]) {\n\t\ttry {\n\t\t\tw();\n\t\t} catch(e){\n\t\t\tconsole.error(e);\n\t\t}\n\t}\n}\n","import { markRead, markChange, createExecutable, getValue, getProxy } from './state';\nimport { safeify } from './utils';\n\n/** 取消监听的方法 */\nexport interface CancelWatch {\n\t(): void;\n}\n/** 可监听值 */\nexport interface Value<T> {\n\t(): T;\n\t(v: T, mrak?: boolean): T;\n\tvalue: T;\n\twatch(cb: WatchCallback<T, this>): CancelWatch;\n\tstop(): void;\n}\n/** 监听函数 */\nexport interface WatchCallback<T, V extends Value<T> = Value<T>> {\n\t(v: V, stoped: boolean): void;\n}\nconst values = new WeakSet<Value<any>>();\nexport function isValue(x: any): x is Value<any> {\n\treturn values.has(x);\n}\n/** 触发监听 */\ninterface Trigger {\n\t(): void;\n\t/** 是否存在监听函数 */\n\thas(): boolean;\n\t/** 停止监听 */\n\tstop(): void;\n}\nexport interface Options {\n\tproxy?: boolean;\n}\n\n\nfunction createValue<T, V extends Value<T> = Value<T>>(\n\tsetValue: (value: T, markChange: () => void) => void,\n\tgetValue: () => T,\n\tstop: () => void = () => {},\n\tchange: () => void = () => {},\n) {\n\tfunction set(v: T, marked = false) {\n\t\ttry {\n\t\t\treturn setValue(v, () => { marked = true; });\n\t\t} finally {\n\t\t\tif (marked) {\n\t\t\t\ttrigger();\n\t\t\t}\n\t\t}\n\t}\n\tfunction get() {\n\t\tmarkRead(value, 'value');\n\t\treturn getValue();\n\t}\n\tconst value: V = ((...v: [T] | [T, boolean] | []): T => {\n\t\tif (v.length) {\n\t\t\tset(v[0], v[1]);\n\t\t\treturn v[0];\n\t\t}\n\t\treturn get();\n\t}) as V;\n\tReflect.defineProperty(value, 'value', {\n\t\tget,\n\t\tset,\n\t\tenumerable: true,\n\t\tconfigurable: true,\n\t});\n\n\tfunction watch(cb: WatchCallback<T, V>): () => void {\n\t\tif (!callbacks) { return () => {}; }\n\t\tcb = safeify(cb);\n\t\tcallbacks.push(cb);\n\t\tchange();\n\t\tlet cancelled = false;\n\t\treturn () => {\n\t\t\tif (cancelled) { return; }\n\t\t\tcancelled = true;\n\t\t\tif (!callbacks) { return; }\n\t\t\tconst index = callbacks.findIndex(a => a === cb);\n\t\t\tif (index < 0) { return; }\n\t\t\tcallbacks.splice(index, 1);\n\t\t\tchange();\n\t\t};\n\t}\n\tlet callbacks: WatchCallback<T, V>[] | undefined = [];\n\tReflect.defineProperty(value, 'watch', {\n\t\tget() { return watch; },\n\t\tset() {},\n\t\tconfigurable: true,\n\t});\n\tconst trigger = (() => {\n\t\tif (!callbacks) { return; }\n\t\tmarkChange(value, 'value');\n\t\tfor (const cb of [...callbacks]) {\n\t\t\tcb(value, false);\n\t\t}\n\t}) as Trigger;\n\ttrigger.has = () => Boolean(callbacks?.length);\n\ttrigger.stop = () => {\n\t\tif (!callbacks) { return; }\n\t\tconst list = callbacks;\n\t\tcallbacks = undefined;\n\t\tfor (const cb of [...list]) {\n\t\t\tcb(value, true);\n\t\t}\n\t};\n\tvalues.add(value);\n\tlet stoped = false;\n\tvalue.stop = () => {\n\t\tif (stoped) { return; }\n\t\tstoped = true;\n\t\tstop();\n\t\ttrigger.stop();\n\n\t};\n\treturn {value, trigger};\n}\nexport function value<T>(value: T, options?: Options | boolean): Value<T>;\nexport function value<T>(def: T, options?: Options | boolean): Value<T> {\n\tconst proxy = options === true || options && options.proxy;\n\tlet source: T;\n\tlet proxyed: T;\n\tconst { value } = createValue<T>(\n\t\t(v, mark) => {\n\t\t\tif (proxy) { v = getValue(v); }\n\t\t\tif (v === source) { return; }\n\t\t\tsource = v;\n\t\t\tproxyed = proxy ? getProxy(source) : source;\n\t\t\tmark();\n\t\t},\n\t\t() => proxyed,\n\t);\n\tvalue(def);\n\treturn value;\n}\n\n/** 计算值 */\nexport function computed<T>(source: () => T, options?: Options | boolean): Value<T>;\nexport function computed<T>(getter: () => T, options?: Options | boolean): Value<T> {\n\tconst proxy = options === true || options && options.proxy;\n\tlet source: T;\n\tlet proxyed: T;\n\tlet stoped = false;\n\tlet computed = false;\n\tlet trigger: Trigger | undefined;\n\tconst executable = createExecutable(getter, changed => {\n\t\tcomputed = !changed;\n\t\tif (changed  && trigger) {\n\t\t\ttrigger();\n\t\t}\n\t});\n\tfunction run() {\n\t\tcomputed = true;\n\t\ttry {\n\t\t\tsource = executable();\n\t\t\tif (proxy) { source = getValue(source); }\n\t\t\tproxyed = proxy ? getProxy(source) : source;\n\t\t\treturn proxyed;\n\t\t} catch(e) {\n\t\t\tif (!stoped) {\n\t\t\t\tcomputed = false;\n\t\t\t}\n\t\t\tthrow e;\n\t\t}\n\n\t}\n\tlet value: Value<T>;\n\t({value, trigger} = createValue<T, Value<T>>(\n\t\t(v: T, mark) => {\n\t\t\t// TODO\n\t\t\t// v = getValue(v);\n\t\t\t// if (v === source) { return; }\n\t\t\t// source = v;\n\t\t\t// mark();\n\t\t},\n\t\t() => computed || stoped ? proxyed : run(),\n\t\t() => {\n\t\t\tif (stoped) { return; }\n\t\t\tstoped = true;\n\t\t\tif (computed) { return; }\n\t\t\trun();\n\t\t},\n\t));\n\treturn value;\n\n}\n\nexport function merge<T, V extends Value<T> = Value<T>>(cb: WatchCallback<T, V>): WatchCallback<T, V> {\n\tlet oldValue: any;\n\tlet runed = false;\n\treturn (v, stoped) => {\n\t\tif (stoped) { return cb(v, stoped); }\n\t\tconst newValue = getValue(v());\n\t\tif (newValue === oldValue && runed) { return; }\n\t\truned = true;\n\t\toldValue = newValue;\n\t\tcb(v, stoped);\n\t};\n}\n\ntype OffValue<V> = V extends Value<infer T> ? T : V;\n\nexport function mix<T extends object>(source: T): { [K in keyof T]: OffValue<T[K]>; } {\n\tfor (const k of Reflect.ownKeys(source)) {\n\t\tconst descriptor = Reflect.getOwnPropertyDescriptor(source, k);\n\t\tif (!descriptor) { continue; }\n\t\tif ('get' in descriptor || 'set' in descriptor || !('value' in descriptor)) { continue; }\n\t\tconst value = descriptor.value;\n\t\tif (!isValue(value)) { continue; }\n\t\tdescriptor.get = () => value();\n\t\tif (descriptor.writable) {\n\t\t\tdescriptor.set = (v) => value(v);\n\t\t}\n\t\tdelete descriptor.value;\n\t\tdelete descriptor.writable;\n\t\tReflect.defineProperty(source, k, descriptor);\n\t}\n\treturn source as any;\n}\n"],"names":["safeify","fn","p","e","console","error","ValueMap","WeakMap","ProxyHandler","get","target","prop","receiver","markRead","String","Reflect","set","value","markChange","isProxyable","v","Boolean","includes","getProxy","has","Proxy","getValue","read","obj","Set","add","createExecutable","cb","cancelList","cancel","list","undefined","forEach","f","trigger","exec","thisRead","Map","oldRead","clear","size","props","push","watchProp","stop","watchList","key","map","removed","index","findIndex","a","splice","length","delete","watch","w","values","WeakSet","isValue","x","createValue","setValue","change","marked","defineProperty","enumerable","configurable","callbacks","cancelled","stoped","def","options","proxy","source","proxyed","mark","computed","getter","executable","changed","run","merge","oldValue","runed","newValue","mix","k","ownKeys","descriptor","getOwnPropertyDescriptor","writable"],"mappings":"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"}